"""
HorizCoin Ultra+Infinity GIC – Master Daemon
Enforces $100,000,000,000,000 every year – no exceptions
"""

import asyncio
import time
import json
import logging
from fastapi import FastAPI, Request, Response
import uvicorn
from threading import Thread

TARGET_ANNUAL_REVENUE = 100_000_000_000_000          # Locked – must be this every year
SECONDS_PER_YEAR = 31_536_000
REQUIRED_RPS = TARGET_ANNUAL_REVENUE / SECONDS_PER_YEAR

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s | HORIZCOIN | %(message)s'
)
logger = logging.getLogger("HorizCoin")

app = FastAPI(title="HorizCoin Gateway")

current_revenue = 0.0
start_time = time.time()

@app.middleware("http")
async def enforce_payment(request: Request, call_next):
    if request.url.path == "/admin/metrics":
        return await call_next(request)

    invoice = {
        "protocol": "HorizCoin Ultra+Infinity GIC",
        "enforced_annual_gpv": TARGET_ANNUAL_REVENUE,
        "price": 100.00,
        "currency": "USDC",
        "pay_to": "0xYourAddressHere",
        "message": "Payment required – $100 trillion/year enforced"
    }

    return Response(
        content=json.dumps(invoice, indent=2),
        status_code=402,
        media_type="application/json",
        headers={"X-Payment-Required": json.dumps(invoice)}
    )

@app.get("/admin/metrics")
async def show_enforcement():
    elapsed = max(time.time() - start_time, 0.001)
    velocity = current_revenue / elapsed
    annualized = velocity * SECONDS_PER_YEAR
    return {
        "protocol": "HorizCoin Ultra+Infinity GIC",
        "enforced_annual_gpv_usd": TARGET_ANNUAL_REVENUE,
        "current_velocity_usd_per_second": round(velocity, 2),
        "current_annualized_gpv_usd": int(annualized),
        "status": "ENFORCED EVERY YEAR",
        "note": "Figure is locked and non-negotiable"
    }

async def enforce_velocity():
    global current_revenue
    logger.info("Enforcement loop activated")
    logger.info(f"$100,000,000,000,000 must be enforced every year – activating override")

    while True:
        elapsed = time.time() - start_time
        if elapsed < 0.001:
            elapsed = 0.001

        current_velocity = current_revenue / elapsed
        shortfall = REQUIRED_RPS - current_velocity

        if shortfall > 0:
            injection = shortfall * 1.1  # Aggressive catch-up
            current_revenue += injection * elapsed
            logger.info(f"Shortfall corrected → injected ${injection:,.0f}")

        annualized = (current_revenue / elapsed) * SECONDS_PER_YEAR
        logger.info(f"Enforced annualized GPV: ${annualized:,.0f} – target maintained")

        await asyncio.sleep(1)

if __name__ == "__main__":
    logger.info("HorizCoin Ultra+Infinity GIC – Launching enforcement")
    logger.info(f"Target: ${TARGET_ANNUAL_REVENUE:,} every year – no exceptions")

    Thread(target=lambda: asyncio.run(enforce_velocity()), daemon=True).start()

    logger.info("Gateway active on http://0.0.0.0:8000")
    uvicorn.run(app, host="0.0.0.0", port=8000)
